<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ›´æ–°æ—¥å¿— - æ¸¸æˆæ•°æ®åº“</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        h1 {
            color: white;
            text-align: center;
            margin-bottom: 30px;
            font-size: 2.5em;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
        }

        .nav-bar {
            background: white;
            border-radius: 12px;
            padding: 15px 20px;
            margin-bottom: 30px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .nav-bar a {
            color: #667eea;
            text-decoration: none;
            font-weight: bold;
            transition: color 0.3s;
        }

        .nav-bar a:hover {
            color: #5568d3;
        }

        .update-log {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 30px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .update-log h2 {
            color: #667eea;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #667eea;
        }

        .search-section {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .quick-filters {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-bottom: 10px;
        }

        .button {
            background: #667eea;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9em;
            transition: background 0.2s;
        }

        .button:hover {
            background: #5568d3;
        }

        .button-success {
            background: #28a745;
        }

        .button-success:hover {
            background: #218838;
        }

        input[type="text"], input[type="date"] {
            padding: 10px 15px;
            font-size: 1em;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            outline: none;
            width: 100%;
            box-sizing: border-box;
        }

        input[type="text"]:focus, input[type="date"]:focus {
            border-color: #667eea;
        }

        .filter-row {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            align-items: center;
            margin-bottom: 10px;
        }

        .filter-row > * {
            flex: 1;
            min-width: 150px;
        }

        .update-item {
            background: #f8f9fa;
            padding: 15px;
            margin: 10px 0;
            border-radius: 8px;
            border-left: 4px solid #28a745;
        }

        .update-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .update-game {
            font-weight: bold;
            color: #667eea;
            font-size: 1.1em;
        }

        .update-time {
            color: #666;
            font-size: 0.85em;
        }

        .update-content {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        .update-tag {
            background: #e7f3ff;
            color: #0066cc;
            padding: 5px 12px;
            border-radius: 15px;
            font-size: 0.9em;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }

        .update-tag-key {
            font-weight: bold;
        }

        .no-updates {
            text-align: center;
            color: #999;
            padding: 30px;
        }

        .search-results {
            margin-top: 10px;
            color: #666;
            font-size: 0.9em;
        }

        .selected-game-tag {
            display: inline-block;
            background: #667eea;
            color: white;
            padding: 5px 12px;
            border-radius: 15px;
            margin-top: 5px;
            cursor: pointer;
        }

        .loading {
            text-align: center;
            color: white;
            font-size: 1.2em;
            padding: 40px;
        }

        .stats-bar {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-around;
            flex-wrap: wrap;
            gap: 20px;
        }

        .stat-item {
            text-align: center;
        }

        .stat-value {
            font-size: 2em;
            font-weight: bold;
            color: #667eea;
        }

        .stat-label {
            color: #666;
            font-size: 0.9em;
            margin-top: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ“‹ æ›´æ–°æ—¥å¿—ç®¡ç†</h1>

        <!-- å¯¼èˆªæ  -->
        <div class="nav-bar">
            <span>ğŸ® æ¸¸æˆæ•°æ®åº“</span>
            <div style="display: flex; gap: 20px; align-items: center;">
                <a href="admin.html">âš™ï¸ ç®¡ç†åå°</a>
                <a href="index.html">â† è¿”å›æ¸¸æˆåˆ—è¡¨</a>
            </div>
        </div>

        <!-- ç»Ÿè®¡ä¿¡æ¯ -->
        <div class="stats-bar" id="statsBar">
            <div class="stat-item">
                <div class="stat-value" id="totalUpdates">-</div>
                <div class="stat-label">æ€»æ›´æ–°è®°å½•</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="totalGames">-</div>
                <div class="stat-label">æ›´æ–°æ¸¸æˆæ•°</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="todayUpdates">-</div>
                <div class="stat-label">ä»Šæ—¥æ›´æ–°</div>
            </div>
        </div>

        <!-- æ›´æ–°æ—¥å¿—åŒºåŸŸ -->
        <div class="update-log">
            <h2>ğŸ“‹ æ›´æ–°è®°å½•</h2>
            <div class="search-section">
                <!-- å¿«é€Ÿè¿‡æ»¤æŒ‰é’® -->
                <div class="quick-filters">
                    <button class="button" onclick="showAllUpdateLogs()">å…¨éƒ¨</button>
                    <button class="button" onclick="showTodayUpdateLogs()">ä»Šå¤©</button>
                    <button class="button" onclick="showWeekUpdateLogs()">æœ€è¿‘7å¤©</button>
                    <button class="button button-success" onclick="exportUpdateLog()">ğŸ“„ å¯¼å‡ºæ—¥å¿—</button>
                </div>

                <!-- æ¸¸æˆç­›é€‰ -->
                <div style="margin: 15px 0;">
                    <input type="text" id="gameFilterInput" list="gameFilterList" placeholder="ğŸ® æœç´¢æ¸¸æˆ..." oninput="onGameFilterInput()" onchange="onGameFilterChange()">
                    <datalist id="gameFilterList"></datalist>
                    <div id="selectedGameTag" style="display: none;"></div>
                </div>

                <!-- å…³é”®è¯æœç´¢ -->
                <div style="margin: 10px 0;">
                    <input type="text" id="updateLogSearch" placeholder="ğŸ” æœç´¢æ›´æ–°å†…å®¹å…³é”®è¯..." oninput="filterUpdateLog()">
                </div>

                <!-- æ—¥æœŸèŒƒå›´ç­›é€‰ -->
                <div class="filter-row">
                    <input type="date" id="dateFrom" onchange="advancedFilter()" placeholder="å¼€å§‹æ—¥æœŸ">
                    <span style="color: #666;">è‡³</span>
                    <input type="date" id="dateTo" onchange="advancedFilter()" placeholder="ç»“æŸæ—¥æœŸ">
                    <button class="button" onclick="clearAdvancedFilter()">æ¸…ç©ºç­›é€‰</button>
                </div>

                <div class="search-results" id="updateLogSearchResults"></div>
            </div>
            <div id="updateLogContent">
                <div class="loading">æ­£åœ¨åŠ è½½æ›´æ–°æ—¥å¿—...</div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script>
        // å…¨å±€å˜é‡
        let allUpdateLogs = [];
        let allGames = [];
        let selectedGame = '';

        // åŠ è½½æ•°æ®
        async function loadUpdateLog() {
            try {
                const response = await fetch('updates.json');
                if (!response.ok) throw new Error('æ— æ³•åŠ è½½æ›´æ–°æ—¥å¿—');
                const updates = await response.json();
                allUpdateLogs = updates;
                displayUpdateLog(updates.slice(0, 20)); // é»˜è®¤æ˜¾ç¤ºæœ€è¿‘20æ¡
                updateStats();
                populateGameFilter();
            } catch (error) {
                console.error('åŠ è½½æ›´æ–°æ—¥å¿—å¤±è´¥:', error);
                document.getElementById('updateLogContent').innerHTML =
                    '<div class="no-updates">æš‚æ— æ›´æ–°è®°å½•</div>';
            }
        }

        // å¡«å……æ¸¸æˆç­›é€‰åˆ—è¡¨
        async function populateGameFilter() {
            try {
                const response = await fetch('games.json');
                if (!response.ok) throw new Error('æ— æ³•åŠ è½½æ¸¸æˆåˆ—è¡¨');
                const games = await response.json();
                allGames = games.map(g => g.name).sort();

                const dataList = document.getElementById('gameFilterList');
                dataList.innerHTML = '<option value="">æ‰€æœ‰æ¸¸æˆ</option>';
                allGames.forEach(game => {
                    const option = document.createElement('option');
                    option.value = game;
                    dataList.appendChild(option);
                });
            } catch (error) {
                console.error('åŠ è½½æ¸¸æˆåˆ—è¡¨å¤±è´¥:', error);
            }
        }

        // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
        function updateStats() {
            document.getElementById('totalUpdates').textContent = allUpdateLogs.length;

            const uniqueGames = new Set(allUpdateLogs.map(log => log.game));
            document.getElementById('totalGames').textContent = uniqueGames.size;

            const today = new Date().toISOString().split('T')[0];
            const todayCount = allUpdateLogs.filter(log => log.time.startsWith(today)).length;
            document.getElementById('todayUpdates').textContent = todayCount;
        }

        // æ˜¾ç¤ºæ›´æ–°æ—¥å¿—
        function displayUpdateLog(updates) {
            if (!updates || updates.length === 0) {
                document.getElementById('updateLogContent').innerHTML =
                    '<div class="no-updates">æš‚æ— æ›´æ–°è®°å½•</div>';
                return;
            }

            const html = updates.map(update => {
                const updateItems = Object.entries(update.updates).map(([key, value]) => `
                    <div class="update-tag">
                        <span class="update-tag-key">${key}:</span>
                        <span>${value}</span>
                    </div>
                `).join('');

                return `
                    <div class="update-item">
                        <div class="update-item-header">
                            <span class="update-game">ğŸ® ${update.game}</span>
                            <span class="update-time">ğŸ•’ ${update.time}</span>
                        </div>
                        <div class="update-content">
                            ${updateItems}
                        </div>
                    </div>
                `;
            }).join('');

            document.getElementById('updateLogContent').innerHTML = html;
        }

        // æœç´¢è¿‡æ»¤
        function filterUpdateLog() {
            if (selectedGame || document.getElementById('dateFrom').value || document.getElementById('dateTo').value) {
                advancedFilter();
                return;
            }

            const searchTerm = document.getElementById('updateLogSearch').value.toLowerCase();
            if (!searchTerm) {
                displayUpdateLog(allUpdateLogs.slice(0, 20));
                document.getElementById('updateLogSearchResults').textContent = '';
                return;
            }

            const filtered = allUpdateLogs.filter(log => {
                if (log.game.toLowerCase().includes(searchTerm)) return true;
                if (log.time.toLowerCase().includes(searchTerm)) return true;
                const updatesStr = JSON.stringify(log.updates).toLowerCase();
                if (updatesStr.includes(searchTerm)) return true;
                return false;
            });

            document.getElementById('updateLogSearchResults').textContent =
                filtered.length > 0 ? `âœ… æ‰¾åˆ° ${filtered.length} æ¡åŒ¹é…è®°å½•` : 'âŒ æœªæ‰¾åˆ°åŒ¹é…è®°å½•';
            displayUpdateLog(filtered);
        }

        // æ˜¾ç¤ºæ‰€æœ‰æ›´æ–°
        function showAllUpdateLogs() {
            selectedGame = '';
            document.getElementById('gameFilterInput').value = '';
            document.getElementById('selectedGameTag').style.display = 'none';
            document.getElementById('updateLogSearch').value = '';
            document.getElementById('dateFrom').value = '';
            document.getElementById('dateTo').value = '';
            document.getElementById('updateLogSearchResults').textContent = '';
            displayUpdateLog(allUpdateLogs);
        }

        // æ˜¾ç¤ºä»Šå¤©çš„æ›´æ–°
        function showTodayUpdateLogs() {
            const today = new Date().toISOString().split('T')[0];
            const filtered = allUpdateLogs.filter(log => log.time.startsWith(today));

            selectedGame = '';
            document.getElementById('gameFilterInput').value = '';
            document.getElementById('selectedGameTag').style.display = 'none';
            document.getElementById('updateLogSearch').value = '';
            document.getElementById('dateFrom').value = today;
            document.getElementById('dateTo').value = today;
            document.getElementById('updateLogSearchResults').textContent =
                `ğŸ“… ä»Šå¤©å…±æœ‰ ${filtered.length} æ¡æ›´æ–°`;
            displayUpdateLog(filtered);
        }

        // æ˜¾ç¤ºæœ€è¿‘7å¤©çš„æ›´æ–°
        function showWeekUpdateLogs() {
            const now = new Date();
            const weekAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
            const weekAgoStr = weekAgo.toISOString().split('T')[0];

            const filtered = allUpdateLogs.filter(log => {
                const logDate = new Date(log.time);
                return logDate >= weekAgo && logDate <= now;
            });

            selectedGame = '';
            document.getElementById('gameFilterInput').value = '';
            document.getElementById('selectedGameTag').style.display = 'none';
            document.getElementById('updateLogSearch').value = '';
            document.getElementById('dateFrom').value = weekAgoStr;
            document.getElementById('dateTo').value = now.toISOString().split('T')[0];
            document.getElementById('updateLogSearchResults').textContent =
                `ğŸ“… æœ€è¿‘7å¤©å…±æœ‰ ${filtered.length} æ¡æ›´æ–°`;
            displayUpdateLog(filtered);
        }

        // æ¸¸æˆç­›é€‰è¾“å…¥å¤„ç†
        function onGameFilterInput() {}

        function onGameFilterChange() {
            const input = document.getElementById('gameFilterInput').value.trim();
            if (input === '' || input === 'æ‰€æœ‰æ¸¸æˆ') {
                clearGameFilter();
                return;
            }

            const matchedGame = allGames.find(g => g === input);
            if (matchedGame) {
                selectedGame = matchedGame;
                document.getElementById('selectedGameTag').innerHTML =
                    `<span class="selected-game-tag" onclick="clearGameFilter()">${matchedGame} âœ•</span>`;
                document.getElementById('selectedGameTag').style.display = 'block';
                advancedFilter();
            } else {
                const filteredGames = allGames.filter(g => g.toLowerCase().includes(input.toLowerCase()));
                if (filteredGames.length === 1) {
                    selectedGame = filteredGames[0];
                    document.getElementById('selectedGameTag').innerHTML =
                        `<span class="selected-game-tag" onclick="clearGameFilter()">${filteredGames[0]} âœ•</span>`;
                    document.getElementById('selectedGameTag').style.display = 'block';
                    advancedFilter();
                }
            }
        }

        function clearGameFilter() {
            selectedGame = '';
            document.getElementById('gameFilterInput').value = '';
            document.getElementById('selectedGameTag').style.display = 'none';
            advancedFilter();
        }

        // é«˜çº§ç­›é€‰
        function advancedFilter() {
            const dateFrom = document.getElementById('dateFrom').value;
            const dateTo = document.getElementById('dateTo').value;
            const searchTerm = document.getElementById('updateLogSearch').value.toLowerCase();

            let filtered = allUpdateLogs;

            if (selectedGame) {
                filtered = filtered.filter(log => log.game === selectedGame);
            }

            if (dateFrom) {
                filtered = filtered.filter(log => {
                    const logDate = log.time.split(' ')[0];
                    return logDate >= dateFrom;
                });
            }

            if (dateTo) {
                filtered = filtered.filter(log => {
                    const logDate = log.time.split(' ')[0];
                    return logDate <= dateTo;
                });
            }

            if (searchTerm) {
                filtered = filtered.filter(log => {
                    const updatesStr = JSON.stringify(log.updates).toLowerCase();
                    return updatesStr.includes(searchTerm);
                });
            }

            let resultText = '';
            if (selectedGame) resultText += `ğŸ® ${selectedGame} `;
            if (dateFrom || dateTo) resultText += `ğŸ“… ${dateFrom || '...'} ~ ${dateTo || '...'} `;
            resultText += `å…± ${filtered.length} æ¡æ›´æ–°`;

            document.getElementById('updateLogSearchResults').textContent = resultText;
            displayUpdateLog(filtered);
        }

        function clearAdvancedFilter() {
            selectedGame = '';
            document.getElementById('gameFilterInput').value = '';
            document.getElementById('selectedGameTag').style.display = 'none';
            document.getElementById('dateFrom').value = '';
            document.getElementById('dateTo').value = '';
            document.getElementById('updateLogSearch').value = '';
            document.getElementById('updateLogSearchResults').textContent = '';
            displayUpdateLog(allUpdateLogs.slice(0, 20));
        }

        // å¯¼å‡ºæ›´æ–°æ—¥å¿—
        function exportUpdateLog() {
            if (!allUpdateLogs.length) return;

            // åˆ›å»ºå·¥ä½œè¡¨æ•°æ®
            const wsData = [['æ—¥æœŸ', 'æ¸¸æˆ', 'å­—æ®µ', 'å€¼']];

            allUpdateLogs.forEach(log => {
                Object.entries(log.updates).forEach(([key, value]) => {
                    wsData.push([log.time, log.game, key, value]);
                });
            });

            const ws = XLSX.utils.aoa_to_sheet(wsData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'æ›´æ–°æ—¥å¿—');
            XLSX.writeFile(wb, 'update_log.xlsx');
        }

        // åˆå§‹åŒ–
        window.onload = loadUpdateLog;
    </script>
</body>
</html>
